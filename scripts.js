const SUPABASE_URL="https://exuutmlbezajrqwchkck.supabase.co",SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4dXV0bWxiZXphanJxd2Noa2NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3MjU5ODYsImV4cCI6MjA3MzMwMTk4Nn0.GXBs9vfzbBu2tGMmZom43FrgqVvhSES4w6gK1oZaoxs",supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);let selectedCurrency=localStorage.getItem("selectedCurrency")||"USD";const exchangeRates={USD:1,USDT:.99,CUP:400,CUPT:440},currencySymbols={USD:"$",USDT:"$",CUP:"$",CUPT:"$"},currencyNames={USD:"USD Cash",USDT:"USDT Criptos",CUP:"CUP Efectivo",CUPT:"CUP Transferencia"};let cartItems=JSON.parse(localStorage.getItem("cartItems"))||[],currentProductModal=null,currentSearchQuery="",searchTimeout=null,currentSlide=0,totalSlides=0;const CACHE_CONFIG={IMAGE_CACHE:"image-cache-v1",DATA_CACHE:"data-cache-v1",MAX_IMAGE_AGE:6048e5,MAX_DATA_AGE:864e5,MAX_IMAGES_TO_CACHE:50,CACHE_STRATEGY:"stale-while-revalidate"};function checkImageExists(e,t){const a=new Image;a.onload=function(){t(!0)},a.onerror=function(){t(!1)},a.src=e}function getDefaultImage(e){return{phones:"https://i.postimg.cc/bwmHq1b2/Grid-Art-20250921-083123920.jpg",laptops:"https://i.postimg.cc/bwmHq1b2/Grid-Art-20250921-083123920.jpg",watches:"https://i.postimg.cc/bwmHq1b2/Grid-Art-20250921-083123920.jpg",home:"https://i.postimg.cc/bwmHq1b2/Grid-Art-20250921-083123920.jpg",electronics:"https://i.postimg.cc/bwmHq1b2/Grid-Art-20250921-083123920.jpg"}[e]||"https://i.postimg.cc/bwmHq1b2/Grid-Art-20250921-083123920.jpg"}function shuffleArray(e){const t=[...e];for(let e=t.length-1;e>0;e--){const a=Math.floor(Math.random()*(e+1));[t[e],t[a]]=[t[a],t[e]]}return t}function formatPrice(e){const t=e*exchangeRates[selectedCurrency],a=currencySymbols[selectedCurrency];return"CUP"===selectedCurrency||"CUPT"===selectedCurrency?`${a}${Math.round(t)}`:`${a}${t.toFixed(2)}`}function getCurrencyName(){return currencyNames[selectedCurrency]}function showNotification(e){const t=document.createElement("div");t.className="fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in-out",t.textContent=e,document.body.appendChild(t),setTimeout((()=>{t.classList.add("animate-fade-out"),setTimeout((()=>t.remove()),300)}),3e3)}function isElementInViewport(e){const t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)}function useDefaultImage(e,t){e.src=getDefaultImage(t),e.classList.add("image-error")}async function initCache(){try{return"caches"in window?(await caches.open(CACHE_CONFIG.IMAGE_CACHE),await caches.open(CACHE_CONFIG.DATA_CACHE),console.log("Sistema de caché inicializado correctamente"),!0):(console.warn("El almacenamiento en caché no está disponible en este navegador"),!1)}catch(e){return console.error("Error inicializando el sistema de caché:",e),!1}}async function cacheImage(e,t){try{const a=await caches.open(CACHE_CONFIG.IMAGE_CACHE),n=new Response(t),c=new Headers(n.headers);c.set("x-cache-date",Date.now().toString());const r=new Response(n.body,{status:n.status,statusText:n.statusText,headers:c});return await a.put(e,r),await cleanImageCacheIfNeeded(),!0}catch(e){return console.error("Error almacenando imagen en caché:",e),!1}}async function getCachedImage(e){try{const t=await caches.open(CACHE_CONFIG.IMAGE_CACHE),a=await t.match(e);if(!a)return null;const n=a.headers.get("x-cache-date");return n&&Date.now()-parseInt(n)>CACHE_CONFIG.MAX_IMAGE_AGE?(await t.delete(e),null):await a.blob()}catch(e){return console.error("Error obteniendo imagen desde caché:",e),null}}async function cleanImageCacheIfNeeded(){try{const e=await caches.open(CACHE_CONFIG.IMAGE_CACHE),t=await e.keys();if(t.length<=CACHE_CONFIG.MAX_IMAGES_TO_CACHE)return;const a=await Promise.all(t.map((async t=>{const a=(await e.match(t)).headers.get("x-cache-date");return{request:t,date:a?parseInt(a):0}})));a.sort(((e,t)=>e.date-t.date));const n=a.slice(0,t.length-CACHE_CONFIG.MAX_IMAGES_TO_CACHE);for(const t of n)await e.delete(t.request);console.log(`Se eliminaron ${n.length} imágenes del caché`)}catch(e){console.error("Error limpiando caché de imágenes:",e)}}async function loadImageWithCache(e,t,a){const n=await getCachedImage(t);if(n){const c=URL.createObjectURL(n);return e.src=c,e.onload=()=>URL.revokeObjectURL(c),updateImageInBackground(t,e,a),!0}return loadAndCacheImage(e,t,a)}async function loadAndCacheImage(e,t,a){return new Promise((n=>{checkImageExists(t,(async c=>{if(c)try{const a=await fetch(t),c=await a.blob();await cacheImage(t,c),e.src=t,e.classList.remove("image-error"),n(!0)}catch(t){console.error("Error cargando imagen:",t),useDefaultImage(e,a),n(!1)}else useDefaultImage(e,a),n(!1)}))}))}async function updateImageInBackground(e,t,a){try{const a=await caches.open(CACHE_CONFIG.IMAGE_CACHE),n=await a.match(e);if(!n)return;const c=n.headers.get("x-cache-date");Date.now()-parseInt(c)>864e5&&fetch(e).then((async a=>{if(a.ok){const n=await a.blob();if(await cacheImage(e,n),isElementInViewport(t)){const e=URL.createObjectURL(n);t.src=e,t.onload=()=>URL.revokeObjectURL(e)}}})).catch((e=>{console.error("Error actualizando imagen en segundo plano:",e)}))}catch(e){console.error("Error en actualización de imagen en segundo plano:",e)}}async function cacheData(e,t){try{const a=await caches.open(CACHE_CONFIG.DATA_CACHE),n={data:t,timestamp:Date.now()},c=new Response(JSON.stringify(n));return await a.put(e,c),!0}catch(e){return console.error("Error almacenando datos en caché:",e),!1}}async function getCachedData(e){try{const t=await caches.open(CACHE_CONFIG.DATA_CACHE),a=await t.match(e);if(!a)return null;const n=await a.json();return Date.now()-n.timestamp>CACHE_CONFIG.MAX_DATA_AGE?(await t.delete(e),null):n.data}catch(e){return console.error("Error obteniendo datos desde caché:",e),null}}async function fetchWithCache(e,t){const a=await getCachedData(e);if(a)return setTimeout((async()=>{try{const a=await t();await cacheData(e,a)}catch(e){console.error("Error actualizando datos en segundo plano:",e)}}),0),a;try{const a=await t();return await cacheData(e,a),a}catch(e){throw console.error("Error obteniendo datos:",e),e}}function initCurrencySelector(){const e=document.getElementById("currencySelector"),t=document.getElementById("currencyOptions");document.getElementById("currentCurrency").textContent=selectedCurrency,e.addEventListener("click",(function(e){e.stopPropagation(),t.classList.toggle("show")})),document.querySelectorAll(".currency-option").forEach((e=>{e.addEventListener("click",(function(){selectCurrency(this.getAttribute("data-currency")),t.classList.remove("show")}))})),document.addEventListener("click",(function(a){e.contains(a.target)||t.contains(a.target)||t.classList.remove("show")})),document.querySelectorAll(".currency-option").forEach((e=>{e.getAttribute("data-currency")===selectedCurrency?e.classList.add("active"):e.classList.remove("active")}))}function selectCurrency(e){selectedCurrency=e,localStorage.setItem("selectedCurrency",e),document.getElementById("currentCurrency").textContent=e,document.querySelectorAll(".currency-option").forEach((t=>{t.getAttribute("data-currency")===e?t.classList.add("active"):t.classList.remove("active")})),updateAllPrices(),document.getElementById("cartModal").classList.contains("hidden")||updateCartModal()}function updateAllPrices(){if(document.querySelectorAll(".price-tag").forEach((e=>{const t=parseFloat(e.getAttribute("data-usd-price"));isNaN(t)||(e.textContent=formatPrice(t))})),document.querySelectorAll(".text-gray-500.line-through").forEach((e=>{const t=parseFloat(e.getAttribute("data-usd-price"));isNaN(t)||(e.textContent=formatPrice(t))})),!document.getElementById("productModal").classList.contains("hidden")){const e=document.getElementById("productModalPrice"),t=document.getElementById("productModalOldPrice");if(e&&e.getAttribute("data-usd-price")){const t=parseFloat(e.getAttribute("data-usd-price"));e.textContent=formatPrice(t)}if(t&&t.getAttribute("data-usd-price")){const e=parseFloat(t.getAttribute("data-usd-price"));t.textContent=formatPrice(e)}}document.querySelectorAll(".discount-badge").forEach((e=>{const t=parseFloat(e.getAttribute("data-original-usd")),a=parseFloat(e.getAttribute("data-discount-usd"));if(!isNaN(t)&&!isNaN(a)){const n=Math.round(100*(1-a/t));e.textContent=`-${n}%`}}))}function displayProducts(e,t,a=!1){t.innerHTML="",0!==e.length?(e.forEach((e=>{const n=document.createElement("div");n.className="product-card bg-white product-item",n.setAttribute("data-category",e.category);const c=e.old_price&&e.old_price>e.price,r=c?Math.round(100*(1-e.price/e.old_price)):0,o=e.description?e.description.replace(/"/g,"&quot;").replace(/'/g,"&#39;"):"",s=e.name?e.name.replace(/"/g,"&quot;").replace(/'/g,"&#39;"):"Producto sin nombre",i=e.devices?e.devices.name:"";let d=[];d=e.images&&e.images.length>0?e.images:e.image?[e.image]:[getDefaultImage(e.category)];const l=d[0];n.innerHTML=`\n                <div class="relative">\n                    <img src="${getDefaultImage(e.category)}" alt="${s}" \n                         class="w-full h-40 object-contain p-4 cursor-pointer product-image image-error"\n                         data-name="${s}"\n                         data-price="${e.price}"\n                         data-old-price="${e.old_price||0}"\n                         data-description="${o}"\n                         data-image="${l}"\n                         data-images='${JSON.stringify(d)}'\n                         data-device-name="${i}"\n                         data-category="${e.category}">\n                    ${c?`<span class="discount-badge" data-original-usd="${e.old_price}" data-discount-usd="${e.price}">-${r}%</span>`:""}\n                    ${a?'<div class="absolute top-0 left-0 bg-orange-500 text-white text-xs font-bold px-2 py-1">OFERTA</div>':""}\n                </div>\n                <div class="p-3">\n                    <h3 class="font-semibold text-sm line-clamp-2">${s}</h3>\n                    <div class="flex items-center mt-1">\n                        <span class="price-tag text-lg" data-usd-price="${e.price}">${formatPrice(e.price)}</span>\n                        ${c?`<span class="text-xs text-gray-500 line-through ml-2" data-usd-price="${e.old_price}">${formatPrice(e.old_price)}</span>`:""}\n                    </div>\n                    <div class="flex items-center mt-1">\n                        <div class="flex text-yellow-400 text-xs">\n                            <i class="fas fa-star"></i>\n                            <i class="fas fa-star"></i>\n                            <i class="fas fa-star"></i>\n                            <i class="fas fa-star"></i>\n                            <i class="fas fa-star-half-alt"></i>\n                        </div>\n                        <span class="text-xs text-gray-500 ml-1">(128)</span>\n                    </div>\n                    <button class="add-to-cart-btn text-white w-full py-2 rounded-lg mt-3 text-sm font-medium flex items-center justify-center"\n                            data-name="${s}" \n                            data-price="${e.price}" \n                            data-image="${l}"\n                            data-device-name="${i}">\n                        <i class="fas fa-shopping-cart mr-2"></i> Añadir\n                    </button>\n                </div>\n            `,t.appendChild(n);const u=n.querySelector("img");u&&loadImageWithCache(u,l,e.category)})),t.querySelectorAll(".product-image").forEach((e=>{e.addEventListener("click",(function(){openProductModal(this)}))})),updateAllPrices()):t.innerHTML=`\n                <div class="col-span-full text-center py-10">\n                    <i class="fas fa-${a?"tag":"box-open"} text-4xl text-gray-300 mb-3"></i>\n                    <h3 class="text-lg font-medium text-gray-500">${a?"No hay ofertas disponibles":"No se encontraron productos"}</h3>\n                </div>\n            `}async function loadProductsFromSupabase(){try{const e=document.getElementById("productsContainer");e.innerHTML='<div class="loading-spinner"></div>';const t=await fetchWithCache("products",(async()=>{const{data:e,error:t}=await supabase.from("products").select("\n                        *,\n                        devices (name)\n                    ").eq("status","active");if(t)throw t;return e}));displayProducts(shuffleArray(t),e)}catch(e){console.error("Error loading products: ",e);document.getElementById("productsContainer").innerHTML='\n                <div class="col-span-full text-center py-10">\n                    <i class="fas fa-exclamation-triangle text-4xl text-red-300 mb-3"></i>\n                    <h3 class="text-lg font-medium text-red-500">Error al cargar los productos</h3>\n                    <p class="text-sm text-gray-500">Por favor, intenta nuevamente más tarde</p>\n                </div>\n            '}}async function loadDailyDealsFromSupabase(){try{const e=document.getElementById("dailyDealsContainer");e.innerHTML='<div class="loading-spinner"></div>';const t=await fetchWithCache("daily-deals",(async()=>{const{data:e,error:t}=await supabase.from("products").select("\n                        *,\n                        devices (name)\n                    ").eq("status","active").not("old_price","is",null).order("created_at",{ascending:!1});if(t)throw t;return e})),a=shuffleArray(t.filter((e=>e.old_price>e.price))).slice(0,4);if(0===a.length)return void(e.innerHTML='\n                    <div class="col-span-full text-center py-10">\n                        <i class="fas fa-tag text-4xl text-gray-300 mb-3"></i>\n                        <h3 class="text-lg font-medium text-gray-500">No hay ofertas disponibles</h3>\n                    </div>\n                ');displayProducts(a,e,!0)}catch(e){console.error("Error loading daily deals: ",e);document.getElementById("dailyDealsContainer").innerHTML='\n                <div class="col-span-full text-center py-10">\n                    <i class="fas fa-exclamation-triangle text-4xl text-red-300 mb-3"></i>\n                    <h3 class="text-lg font-medium text-red-500">Error al cargar las ofertas</h3>\n                </div>\n            '}}function openProductModal(e){const t=e.getAttribute("data-name"),a=parseFloat(e.getAttribute("data-price")),n=parseFloat(e.getAttribute("data-old-price")||0),c=e.getAttribute("data-description"),r=e.getAttribute("data-image"),o=e.getAttribute("data-device-name")||"",s=e.getAttribute("data-category")||"electronics",i=JSON.parse(e.getAttribute("data-images")||"[]");document.getElementById("productModalName").textContent=t,document.getElementById("productModalPrice").textContent=formatPrice(a),document.getElementById("productModalPrice").setAttribute("data-usd-price",a);loadImageWithCache(document.getElementById("productModalImage"),r,s),document.getElementById("productModalDescription").textContent=c;const d=document.getElementById("productImageGallery");d.innerHTML="",i&&i.length>0?(d.classList.remove("hidden"),i.forEach(((e,a)=>{const n=document.createElement("img");n.src=getDefaultImage(s),n.className="image-gallery-thumb",n.alt=`Imagen ${a+1} de ${t}`,loadImageWithCache(n,e,s),0===a&&n.classList.add("active"),n.addEventListener("click",(function(){loadImageWithCache(document.getElementById("productModalImage"),e,s),document.querySelectorAll(".image-gallery-thumb").forEach((e=>e.classList.remove("active"))),this.classList.add("active")})),d.appendChild(n)}))):d.classList.add("hidden"),n&&n>a?(document.getElementById("productModalOldPrice").textContent=formatPrice(n),document.getElementById("productModalOldPrice").setAttribute("data-usd-price",n),document.getElementById("productModalOldPrice").classList.remove("hidden")):document.getElementById("productModalOldPrice").classList.add("hidden"),currentProductModal={name:t,price:a,image:r,deviceName:o,images:i},document.getElementById("productModal").classList.remove("hidden")}function updateCartBadge(){const e=document.getElementById("cartBadge"),t=cartItems.reduce(((e,t)=>e+t.quantity),0);t>0?(e.textContent=t,e.classList.remove("hidden")):e.classList.add("hidden")}function addToCart(e,t,a,n){const c=cartItems.findIndex((t=>t.name===e&&t.deviceName===n));c>=0?cartItems[c].quantity+=1:cartItems.push({name:e,price:t,image:a,deviceName:n,quantity:1}),localStorage.setItem("cartItems",JSON.stringify(cartItems)),updateCartBadge(),showNotification(`${e} añadido al carrito`),document.getElementById("cartModal").classList.contains("hidden")||updateCartModal()}function decreaseQuantity(e){cartItems[e]&&(cartItems[e].quantity>1?cartItems[e].quantity-=1:cartItems.splice(e,1),localStorage.setItem("cartItems",JSON.stringify(cartItems)),updateCartBadge(),updateCartModal())}function increaseQuantity(e){cartItems[e]&&(cartItems[e].quantity+=1,localStorage.setItem("cartItems",JSON.stringify(cartItems)),updateCartBadge(),updateCartModal())}function removeFromCart(e){cartItems[e]&&(cartItems.splice(e,1),localStorage.setItem("cartItems",JSON.stringify(cartItems)),updateCartBadge(),updateCartModal())}function updateCartModal(){const e=document.getElementById("cartItemsContainer"),t=document.getElementById("cartTitle"),a=document.getElementById("subtotal"),n=document.getElementById("total"),c=document.getElementById("shipping"),r=cartItems.reduce(((e,t)=>e+t.quantity),0);t.textContent=`Carrito de Compras (${r})`;const o=cartItems.reduce(((e,t)=>e+t.price*t.quantity),0);a.textContent=formatPrice(o);let s=o>=50?0:.5;c.textContent=0===s?"GRATIS":formatPrice(s);const i=o+s;n.textContent=formatPrice(i),e.innerHTML="",0===cartItems.length?(e.innerHTML='\n                <div class="text-center py-10">\n                    <i class="fas fa-shopping-cart text-4xl text-gray-300 mb-3"></i>\n                    <p class="text-gray-500">Tu carrito está vacío</p>\n                </div>\n            ',document.getElementById("cartSummary").classList.add("hidden")):(document.getElementById("cartSummary").classList.remove("hidden"),cartItems.forEach(((t,a)=>{const n=document.createElement("div");n.className="flex items-center space-x-4 border-b pb-3",n.innerHTML=`\n                    <div class="w-20 h-20 bg-gray-100 rounded-lg flex items-center justify-center">\n                        <img src="${t.image}" alt="${t.name}" class="max-h-full max-w-full" onerror="this.src='${getDefaultImage("electronics")}'">\n                    </div>\n                    <div class="flex-1">\n                        <h4 class="font-medium text-sm line-clamp-1">${t.name}</h4>\n                        ${t.deviceName?`<p class="text-xs text-gray-500">Vendedor: ${t.deviceName}</p>`:""}\n                        <div class="flex justify-between items-center mt-1">\n                            <span class="price-tag text-sm">${formatPrice(t.price)}</span>\n                            <div class="flex items-center space-x-2">\n                                <button class="quantity-btn decrease" data-index="${a}">\n                                    <i class="fas fa-minus text-xs"></i>\n                                </button>\n                                <span class="text-sm">${t.quantity}</span>\n                                <button class="quantity-btn increase" data-index="${a}">\n                                    <i class="fas fa-plus text-xs"></i>\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                    <button class="text-gray-400 remove" data-index="${a}">\n                        <i class="fas fa-trash-alt"></i>\n                    </button>\n                `,e.appendChild(n)})),document.querySelectorAll(".decrease").forEach((e=>{e.addEventListener("click",(e=>{decreaseQuantity(e.target.closest("button").getAttribute("data-index"))}))})),document.querySelectorAll(".increase").forEach((e=>{e.addEventListener("click",(e=>{increaseQuantity(e.target.closest("button").getAttribute("data-index"))}))})),document.querySelectorAll(".remove").forEach((e=>{e.addEventListener("click",(e=>{removeFromCart(e.target.closest("button").getAttribute("data-index"))}))})));const d=document.getElementById("checkoutBtn");0===cartItems.length?d.disabled=!0:d.disabled=!1}function openCheckoutModal(){const e=document.getElementById("orderSummary"),t=document.getElementById("checkoutTotalPrice"),a=cartItems.reduce(((e,t)=>e+t.price*t.quantity),0),n=a>=50?0:.5,c=a+n;e.innerHTML="",cartItems.forEach((t=>{const a=document.createElement("div");a.className="flex justify-between mb-2",a.innerHTML=`\n                <div>\n                    <div>${t.name} x${t.quantity}</div>\n                    ${t.deviceName?`<div class="text-xs text-gray-500">Vendedor: ${t.deviceName}</div>`:""}\n                </div>\n                <span class="price-tag">${formatPrice(t.price*t.quantity)}</span>\n            `,e.appendChild(a)}));const r=document.createElement("div");r.className="flex justify-between border-t border-gray-200 pt-2 mt-2",r.innerHTML=`\n            <span>Subtotal</span>\n            <span>${formatPrice(a)}</span>\n        `,e.appendChild(r);const o=document.createElement("div");o.className="flex justify-between",o.innerHTML=`\n            <span>Envío</span>\n            <span>${0===n?"GRATIS":formatPrice(n)}</span>\n        `,e.appendChild(o),t.textContent=formatPrice(c),document.getElementById("checkoutModal").classList.remove("hidden")}function filterProducts(e){document.querySelectorAll(".category-item").forEach((e=>{e.classList.remove("active"),e.classList.remove("text-indigo-300")}));const t=document.querySelector(`button[onclick="filterProducts('${e}')"]`);t.classList.add("active"),t.classList.add("text-indigo-300"),t.classList.add("filter-active");const a={all:"Todos los Productos",phones:"Teléfonos",laptops:"Laptops",watches:"Smartwatches",accessories:"Accesorios",home:"Hogar",electronics:"Electrónica"};document.getElementById("currentCategory").textContent=a[e]||a.all;const n=document.querySelectorAll(".product-item");let c=!1;n.forEach((t=>{"all"===e||t.getAttribute("data-category")===e?(t.style.display="block",t.classList.add("product-item-visible"),c=!0):(t.style.display="none",t.classList.remove("product-item-visible"))})),c||"all"===e||(document.getElementById("productsContainer").innerHTML='\n                <div class="col-span-full text-center py-10">\n                    <i class="fas fa-box-open text-4xl text-gray-300 mb-3"></i>\n                    <h3 class="text-lg font-medium text-gray-500">No hay productos en esta categoría</h3>\n                </div>\n            '),document.getElementById("productsContainer").scrollIntoView({behavior:"smooth"})}function initSearch(){const e=document.getElementById("searchInput"),t=document.getElementById("searchButton"),a=document.querySelector(".search-bar");t.addEventListener("click",(()=>{performSearch(e.value.trim())})),e.addEventListener("keypress",(t=>{"Enter"===t.key&&performSearch(e.value.trim())})),e.addEventListener("input",(e=>{clearTimeout(searchTimeout);const t=e.target.value.trim();t.length>2?(a.classList.add("searching"),searchTimeout=setTimeout((()=>{performSearch(t),a.classList.remove("searching")}),800)):0===t.length&&clearSearch()}))}async function performSearch(e){if(e)try{const t=document.getElementById("productsContainer");t.innerHTML='<div class="loading-spinner"></div>',document.getElementById("currentCategory").textContent=`Resultados de: "${e}"`;const{data:a,error:n}=await supabase.from("products").select("\n                    *,\n                    devices (name)\n                ").ilike("name",`%${e}%`).eq("status","active");if(n)throw n;displayProducts(a,t),0===a.length&&(t.innerHTML='\n                    <div class="col-span-full text-center py-10 no-results">\n                        <i class="fas fa-search text-4xl text-gray-300 mb-3"></i>\n                        <h3 class="text-lg font-medium text-gray-500">No se encontraron productos</h3>\n                        <p class="text-sm">Intenta con otros términos de búsqueda</p>\n                    </div>\n                ')}catch(e){console.error("Error searching products: ",e),showNotification("Error al buscar productos")}else clearSearch()}function clearSearch(){document.getElementById("searchInput").value="",document.getElementById("currentCategory").textContent="Todos los Productos",loadProductsFromSupabase()}function updateCarousel(){const e=100*-currentSlide;document.querySelector(".carousel-slide").style.transform=`translateX(${e}%)`;document.querySelectorAll(".indicator").forEach(((e,t)=>{t===currentSlide?(e.classList.add("active"),e.classList.remove("bg-opacity-50")):(e.classList.remove("active"),e.classList.add("bg-opacity-50"))}))}function initTextSlider(){const e=document.querySelectorAll(".sliding-text");let t=0;setInterval((()=>{e[t].classList.remove("active"),t=(t+1)%e.length,e[t].classList.add("active")}),3500)}function setupAddToCartListeners(){document.addEventListener("click",(function(e){const t=e.target.closest(".add-to-cart-btn");if(t){e.stopPropagation();const a=t.getAttribute("data-name"),n=parseFloat(t.getAttribute("data-price")),c=t.getAttribute("data-image"),r=t.getAttribute("data-device-name")||"",o=t.innerHTML;t.innerHTML='<i class="fas fa-check mr-2"></i> Añadido',t.classList.add("bg-green-600"),addToCart(a,n,c,r),setTimeout((()=>{t.innerHTML=o,t.classList.remove("bg-green-600")}),1500)}}))}async function initApp(){await initCache()?console.log("Sistema de caché listo para usar"):console.warn("El sistema de caché no se pudo inicializar, usando funcionalidad básica"),initCurrencySelector(),initSearch(),setupAddToCartListeners(),loadProductsFromSupabase(),loadDailyDealsFromSupabase();const e=document.querySelectorAll(".carousel-slide > div");totalSlides=e.length,document.getElementById("nextBtn").addEventListener("click",(()=>{currentSlide=(currentSlide+1)%totalSlides,updateCarousel()})),document.getElementById("prevBtn").addEventListener("click",(()=>{currentSlide=(currentSlide-1+totalSlides)%totalSlides,updateCarousel()})),setInterval((()=>{currentSlide=(currentSlide+1)%totalSlides,updateCarousel()}),5e3),updateCartBadge(),document.getElementById("floatingCartBtn").addEventListener("click",(()=>{updateCartModal(),document.getElementById("cartModal").classList.remove("hidden")})),document.getElementById("closeCartModal").addEventListener("click",(()=>{document.getElementById("cartModal").classList.add("hidden")})),document.getElementById("closeProductModal").addEventListener("click",(()=>{document.getElementById("productModal").classList.add("hidden")})),document.getElementById("addToCartFromModal").addEventListener("click",(()=>{currentProductModal&&(addToCart(currentProductModal.name,currentProductModal.price,currentProductModal.image,currentProductModal.deviceName),document.getElementById("productModal").classList.add("hidden"))})),document.getElementById("checkoutBtn").addEventListener("click",(()=>{cartItems.length>0&&openCheckoutModal()})),document.getElementById("closeCheckoutModal").addEventListener("click",(()=>{document.getElementById("checkoutModal").classList.add("hidden")})),document.getElementById("checkoutForm").addEventListener("submit",(e=>{e.preventDefault();const t=document.getElementById("name").value,a=document.getElementById("phone").value,n=document.getElementById("deliveryLocation").value,c=document.getElementById("address").value,r=document.getElementById("reference").value,o=document.getElementById("productDetails").value,s=cartItems.reduce(((e,t)=>e+t.price*t.quantity),0),i=s>=50?0:.5,d=s+i;let l="¡Hola! Quiero realizar un pedido:%0A%0A";l+=`*Nombre:* ${encodeURIComponent(t)}%0A`,l+=`*Teléfono:* ${encodeURIComponent(a)}%0A`,l+=`*Lugar de entrega:* ${encodeURIComponent(n)}%0A`,l+=`*Dirección:* ${encodeURIComponent(c)}%0A`,l+=`*Punto de referencia:* ${encodeURIComponent(r||"Ninguno")}%0A`,o&&(l+=`*Detalles específicos:* ${encodeURIComponent(o)}%0A`),l+=`%0A*Moneda:* ${encodeURIComponent(getCurrencyName())}%0A`,l+="*Detalles del pedido:*%0A",cartItems.forEach((e=>{l+=`- ${encodeURIComponent(e.name)} x${encodeURIComponent(e.quantity)} (${encodeURIComponent(formatPrice(e.price*e.quantity))})`,e.deviceName&&(l+=` [Vendedor: ${encodeURIComponent(e.deviceName)}]`),l+="%0A"})),l+=`%0A*Subtotal:* ${encodeURIComponent(formatPrice(s))}%0A`,l+=`*Envío:* ${encodeURIComponent(0===i?"GRATIS":formatPrice(i))}%0A`,l+=`*Total:* ${encodeURIComponent(formatPrice(d))}%0A%0A`,l+="¡Gracias!",window.open(`https://wa.me/5353040553?text=${l}`,"_blank"),showNotification("Pedido enviado por WhatsApp"),document.getElementById("checkoutModal").classList.add("hidden"),document.getElementById("cartModal").classList.add("hidden"),cartItems=[],localStorage.setItem("cartItems",JSON.stringify(cartItems)),updateCartBadge(),document.getElementById("checkoutForm").reset()})),initTextSlider();const t=document.createElement("style");t.textContent="\n            @keyframes fade-in-out {\n                0% { opacity: 0; transform: translateY(-10px); }\n                15%, 85% { opacity: 1; transform: translateY(0); }\n                100% { opacity: 0; transform: translateY(-10px); }\n            }\n            \n            .animate-fade-in-out {\n                animation: fade-in-out 3s ease-in-out forwards;\n            }\n            \n            @keyframes fade-out {\n                to { opacity: 0; transform: translateY(-10px); }\n            }\n            \n            .animate-fade-out {\n                animation: fade-out 0.3s ease-in-out forwards;\n            }\n        ",document.head.appendChild(t)}function startCacheCleanupInterval(){setInterval((async()=>{try{const e=await caches.open(CACHE_CONFIG.IMAGE_CACHE),t=await e.keys();for(const a of t){const t=await e.match(a);if(t){const n=t.headers.get("x-cache-date");n&&Date.now()-parseInt(n)>CACHE_CONFIG.MAX_IMAGE_AGE&&await e.delete(a)}}const a=await caches.open(CACHE_CONFIG.DATA_CACHE),n=await a.keys();for(const e of n){const t=await a.match(e);if(t){const n=await t.json();Date.now()-n.timestamp>CACHE_CONFIG.MAX_DATA_AGE&&await a.delete(e)}}console.log("Limpieza periódica de caché completada")}catch(e){console.error("Error en limpieza periódica de caché:",e)}}),864e5)}document.addEventListener("DOMContentLoaded",(function(){initApp(),startCacheCleanupInterval()}));
